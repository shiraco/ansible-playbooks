---
- hosts: ec2
  vars:
    python_version: 3.4.3
    user: ubuntu
    home: /home/{{user}}
  remote_user: ubuntu

  tasks:
    - name: apt-get updates a server
      apt: update_cache=yes
      sudo: yes

    - name: apt-get upgrade a server
      apt: upgrade=full
      sudo: yes

    - name: apt-get install basic pkg
      apt: pkg={{item}} state=installed
      sudo: yes
      with_items:
      - git
      - gcc
      - build-essential
      - zlib1g-dev
      - libbz2-dev
      - libssl-dev
      - libreadline-dev
      - libsqlite3-dev

    - name: Check pyenv installed
      command: test -x {{home}}/.pyenv/bin/pyenv
      register: pyenv_existence
      ignore_errors: yes

    - name: install pyenv
      git: repo=https://github.com/yyuu/pyenv.git dest={{home}}/.pyenv/
      when: pyenv_existence|failed
      ignore_errors: yes

    - name: Check .bash_profile exists
      stat: path={{home}}/.bash_profile
      register: bash_profile_existence

    - name: Set bash_profile config
      copy: src=files/bash_profile dest={{home}}/.bash_profile
      sudo: no
      when: bash_profile_existence.stat.md5 is not defined
      ignore_errors: yes

    - name: install pyenv
      shell: . {{home}}/.bash_profile &&  pyenv install -s {{python_version}} && pyenv rehash && pyenv global {{python_version}}
      when: pyenv_existence|failed

    - name: pip install pkgs
      pip: name={{item}} state=latest executable={{home}}/.pyenv/shims/pip
      with_items:
      - pip
      - virtualenv

    - name: list installed python yversion
      shell: . {{home}}/.bash_profile && pyenv versions
      sudo: no
      register: py_versions

    - debug: var=py_versions

    - name: virtualenv install
      pip: name={{item}} state=latest virtualenv={{home}}/venv virtualenv_command={{home}}/.pyenv/shims/virtualenv virtualenv_site_packages=no
      sudo: no
      with_items:
      - ipython
      - numpy
      - scipy
      - scikit-learn
      - cython

    - name: apt-get install basic pkg
      apt: pkg={{item}} state=installed
      sudo: yes
      with_items:
      - pkg-config
      - gfortran
      - libopenblas-dev
      - libblas-dev
      - liblapack-dev
      - libpng-dev
      - libjpeg8-dev
      - libfreetype6
      - libfreetype6-dev

    - name: virtualenv install
      pip: name={{item}} state=latest virtualenv={{home}}/venv virtualenv_command={{home}}/.pyenv/shims/virtualenv virtualenv_site_packages=no
      sudo: no
      with_items:
      - tornado
      - pytz
      - six
      - pyparsing
      - matplotlib
